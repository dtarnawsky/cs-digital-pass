# Digital Passes

This repository contains information about developing Digital Passes that can be used with Apple Wallet and Google Wallet.

The following folders are used:
- **app** - This contains an example Capacitor application that adds an Apple Wallet Pass or Google Wallet Pass.
- **backend** - This contains a Cloudflare Worker backend (node) that creates the digital pass.

# Apple Wallet Passes

Digital passes for Apple Wallet comes in the form of a file format called `pkpass`. 

These can be created, sent as email attachments, downloaded as files or linked in websites. They are generated by your backend server (see [Creating Apple Passes](#creating-apple-passes)).


## Downloading a pkpass file
You can download a pkpass file (eg in a Capacitor app) using the standard Javascript fetch api:
```typescript
  public async get(url: string): Promise<string> {
    const response = await fetch(url);
    const blob = await response.blob();
    const base64 = await blobToBase64(blob);
    if (!base64 || base64 instanceof ArrayBuffer) {
      throw new Error(`Unable to get ${url}`);
    }
    return base64;
  }
```

As we need the pkpass data base64 encoded we have a helper function called `blobToBase64`:
```typescript
function blobToBase64(blob: Blob): Promise<string | ArrayBuffer | null> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = () => {
      resolve(reader.result);
    };
    reader.readAsDataURL(blob);
  });
}
```

## Adding to Apple Wallet

You can add your pkpass data to the mobile device using a plugin called `capacitor-pass-to-wallet` which you can install with:

```bash
npm install capacitor-pass-to-wallet
npx cap sync
```

Call the `addToWallet` function passing in the base64 pkpass data you downloaded:

```typescript
import { CapacitorPassToWallet } from 'capacitor-pass-to-wallet';
...
await CapacitorPassToWallet.addToWallet({ base64: data });
```

You should see a standard Apple "add pass" dialog with details of your pass. The user can click "Add" to add to Apple Wallet.

## Creating Apple Passes

A tutorial for creating Apple Passes (and a backend to supply them) can be found in [backend/readme.md](./backend/readme.md).

# Google Wallet Passes

## Adding to Google Wallet

Google Wallet has prerequisites for a Google Wallet API issuer account and GCP account (see [documentation](https://developers.google.com/wallet/generic/web/prerequisites)).

In your backend you will [authenticate and authorize](https://developers.google.com/wallet/generic/web) and [create a pass object](https://developers.google.com/wallet/generic/web#creating_a_passes_object).

In your application you can [add a pass to Google Wallet](https://developers.google.com/wallet/generic/web#saving_to) which will generate a JWT token which can then be used in a "Add to Google Wallet" link which is in the format:
`https://pay.google.com/gp/v/save/{token}`

